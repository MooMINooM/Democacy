<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>State Sim V17: The Integrated Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #0f172a; color: #e2e8f0; overflow: hidden; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        
        .panel { background-color: #1e293b; border: 1px solid #334155; border-radius: 0.5rem; }
        .tab-btn.active { background-color: #3b82f6; color: white; }
        
        /* News Feed */
        .news-item { border-left: 3px solid #3b82f6; padding-left: 10px; margin-bottom: 8px; animation: fadeIn 0.5s; }
        .news-item.crisis { border-left-color: #ef4444; background: rgba(239, 68, 68, 0.1); padding: 8px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* Real-time Dot */
        .live-dot { width: 8px; height: 8px; background-color: #ef4444; border-radius: 50%; display: inline-block; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* WAR ROOM (Restored from V14) */
        .wr-region-col { min-width: 200px; display: flex; flex-direction: column; gap: 8px; }
        .wr-region-header { font-size: 11px; font-weight: bold; text-transform: uppercase; color: #94a3b8; border-top: 3px solid #64748b; padding-top: 4px; margin-bottom: 2px; }
        
        .region-border-northeast { border-color: #ef4444; } 
        .region-border-east { border-color: #f97316; } 
        .region-border-south { border-color: #3b82f6; } 
        .region-border-north { border-color: #22c55e; } 
        .region-border-central { border-color: #eab308; } 
        .region-border-bkk { border-color: #a855f7; }

        .wr-province-card { background-color: #151e2e; border: 1px solid #334155; border-radius: 4px; padding: 6px; }
        .wr-province-name { font-size: 9px; color: #94a3b8; margin-bottom: 4px; font-weight: 600; }
        .wr-province-card.my-prov { border-color: #60a5fa; box-shadow: 0 0 10px rgba(96, 165, 250, 0.1); }
        .wr-province-card.my-prov .wr-province-name { color: #93c5fd; }

        .wr-district-grid { display: flex; flex-wrap: wrap; gap: 2px; }
        .wr-district-box { width: 14px; height: 10px; border-radius: 1px; cursor: pointer; transition: all 0.1s; border: 1px solid rgba(255,255,255,0.05); }
        .wr-district-box:hover { transform: scale(1.5); border-color: white; z-index: 10; }
        .wr-district-box.selected { border: 1px solid white; box-shadow: 0 0 5px white; z-index: 5; }
        
        .wr-bar-bg { background-color: #334155; height: 6px; border-radius: 3px; width: 100%; overflow: hidden; margin-top: 2px;}
        .wr-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
    </style>
</head>
<body class="h-screen flex flex-col relative">

    <!-- SETUP SCREEN -->
    <div id="setup-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center p-4 bg-slate-950/95 backdrop-blur-sm">
        <div class="max-w-4xl w-full panel p-8 border-blue-500/30 shadow-2xl animate-fade-in">
            <h1 class="text-4xl font-bold text-blue-500 mb-2 text-center">STATE SIM V17</h1>
            <p class="text-center text-slate-400 text-sm mb-8">Integrated Edition: Real-Time Dashboard + Deep Strategy</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-300">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</label>
                        <input type="text" id="inp-name" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm text-white mb-2" value="‡∏ò‡∏ô‡∏≤ ‡∏£‡∏±‡∏Å‡∏ä‡∏≤‡∏ï‡∏¥">
                        <select id="inp-role" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm text-white">
                            <option value="mp">üèõÔ∏è ‡∏™‡∏™. ‡πÄ‡∏Ç‡∏ï (MP)</option>
                            <option value="pm">‚≠ê ‡∏ô‡∏≤‡∏¢‡∏Å‡∏£‡∏±‡∏ê‡∏°‡∏ô‡∏ï‡∏£‡∏µ (PM)</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-300">‡∏†‡∏π‡∏°‡∏¥‡∏´‡∏•‡∏±‡∏á (Trait)</label>
                        <select id="inp-origin" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm text-white">
                            <option value="general">ü™ñ ‡∏≠‡∏î‡∏µ‡∏ï‡∏ô‡∏≤‡∏¢‡∏û‡∏• (Stability+)</option>
                            <option value="tycoon">üíº ‡πÄ‡∏à‡πâ‡∏≤‡∏™‡∏±‡∏ß‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à (Economy+)</option>
                            <option value="academic">üéì ‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ (Tech+)</option>
                            <option value="activist">üì¢ ‡∏ô‡∏±‡∏Å‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß (Pop+)</option>
                        </select>
                    </div>
                    <div>
                         <label class="text-xs font-bold text-slate-300">‡∏û‡∏£‡∏£‡∏Ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á</label>
                         <select id="inp-party" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm text-white" onchange="checkCustomParty(this)"></select>
                         <input type="text" id="inp-custom-party" class="hidden w-full mt-2 bg-slate-900 border border-yellow-600 rounded p-2 text-sm text-white" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏£‡∏£‡∏Ñ‡πÉ‡∏´‡∏°‡πà...">
                    </div>
                </div>
                <div class="space-y-4">
                    <label class="text-xs font-bold text-slate-300">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ê‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Constituency)</label>
                    <div class="bg-slate-900 p-4 rounded border border-slate-700 h-48 overflow-y-auto">
                        <select id="inp-region" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-xs text-white mb-2" onchange="updateProvinces()">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏Ñ --</option>
                            <option value="bkk">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø</option>
                            <option value="central">‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á</option>
                            <option value="north">‡∏†‡∏≤‡∏Ñ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠</option>
                            <option value="northeast">‡∏†‡∏≤‡∏Ñ‡∏≠‡∏µ‡∏™‡∏≤‡∏ô</option>
                            <option value="south">‡∏†‡∏≤‡∏Ñ‡πÉ‡∏ï‡πâ</option>
                            <option value="east">‡∏†‡∏≤‡∏Ñ‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å</option>
                        </select>
                        <select id="inp-province" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-xs text-white mb-2" onchange="updateDistricts()" disabled>
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î --</option>
                        </select>
                        <select id="inp-district" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-xs text-white" disabled>
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï --</option>
                        </select>
                    </div>
                </div>
            </div>
            <button onclick="startGame()" class="w-full mt-8 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded shadow-lg transition transform hover:scale-[1.02]">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏™‡∏†‡∏≤ (Start Simulation)</button>
        </div>
    </div>

    <!-- MAIN GAME UI -->
    <div id="game-ui" class="hidden flex-1 flex flex-col h-full relative">
        
        <!-- HEADER -->
        <header class="h-14 bg-slate-900 border-b border-slate-700 flex items-center justify-between px-4 shrink-0 shadow z-20">
            <div class="flex items-center gap-4">
                <h1 class="text-lg font-bold text-white tracking-tight">STATE <span class="text-blue-500">SIM</span> <span class="text-[10px] bg-slate-800 px-1 rounded text-slate-400">V17</span></h1>
                
                <!-- Time Controls -->
                <div class="flex items-center gap-2 bg-slate-800 px-2 py-1 rounded border border-slate-700">
                    <button id="btn-play" onclick="togglePlay()" class="w-8 h-8 flex items-center justify-center bg-green-600 hover:bg-green-500 rounded text-white"><i class="fas fa-play"></i></button>
                    <div class="flex flex-col px-2 border-l border-slate-600">
                        <span id="clock-date" class="text-xs font-bold text-white leading-none">01 Jan 2024</span>
                        <span id="clock-time" class="text-[10px] text-slate-400 font-mono">08:00 ‡∏ô.</span>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="setSpeed(1)" class="px-2 py-1 text-[9px] bg-slate-700 hover:bg-slate-600 text-white rounded">1x</button>
                        <button onclick="setSpeed(5)" class="px-2 py-1 text-[9px] bg-slate-700 hover:bg-slate-600 text-white rounded">5x</button>
                    </div>
                </div>
            </div>

            <!-- Top Stats -->
            <div class="flex gap-6 items-center">
                <button onclick="toggleWarRoom()" class="flex items-center gap-2 px-3 py-1 bg-purple-900/50 hover:bg-purple-800 text-purple-200 text-xs font-bold rounded border border-purple-500/50 transition">
                    <i class="fas fa-map-marked-alt"></i> WAR ROOM (400)
                </button>
                <div class="text-right">
                    <div class="text-[10px] text-slate-500 uppercase">Approval</div>
                    <div id="val-pop" class="text-sm font-bold text-green-400 font-mono">50.0%</div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-slate-500 uppercase">Budget</div>
                    <div id="val-money" class="text-sm font-bold text-yellow-400 font-mono">$10.0M</div>
                </div>
            </div>
        </header>

        <main class="flex-1 grid grid-cols-12 gap-0 min-h-0 bg-slate-950">
            
            <!-- LEFT SIDEBAR -->
            <aside class="col-span-3 bg-slate-900 border-r border-slate-800 flex flex-col overflow-y-auto custom-scrollbar">
                
                <!-- Profile Card -->
                <div class="p-4 border-b border-slate-800 bg-slate-800/50">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center text-white font-bold text-lg shadow-lg border-2 border-white/20">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div>
                            <div id="sb-name" class="font-bold text-white text-sm">Player Name</div>
                            <div id="sb-role" class="text-xs text-blue-400 bg-blue-900/30 px-1.5 py-0.5 rounded border border-blue-800 inline-block mt-1">MP</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="bg-slate-900 p-2 rounded border border-slate-700">
                            <div class="text-slate-500 text-[10px]">‡∏û‡∏£‡∏£‡∏Ñ (Party)</div>
                            <div id="sb-party" class="text-white font-bold truncate">...</div>
                        </div>
                        <div class="bg-slate-900 p-2 rounded border border-slate-700">
                            <div class="text-slate-500 text-[10px]">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div>
                            <div id="sb-status" class="text-white font-bold">Opposition</div>
                        </div>
                    </div>
                </div>

                <!-- Constituency Detail (Live Data) -->
                <div class="p-4 flex-1">
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2">
                        <i class="fas fa-map-marker-alt text-red-400"></i> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (Live)
                    </h3>
                    <div class="bg-slate-800 p-3 rounded-lg border border-slate-700 mb-4 shadow-sm">
                        <div id="sb-dist-name" class="text-sm font-bold text-white mb-1">...</div>
                        
                        <!-- Mini Projection -->
                        <div class="mt-2 space-y-1">
                            <div class="flex justify-between text-[10px] text-slate-400"><span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå:</span><span id="sb-my-votes" class="text-green-400">0</span></div>
                            <div class="w-full bg-slate-900 h-1.5 rounded-full overflow-hidden">
                                <div id="sb-vote-bar" class="bg-green-500 h-full transition-all duration-500" style="width:0%"></div>
                            </div>
                            <div class="text-[9px] text-right text-slate-500" id="sb-rank">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö: -</div>
                        </div>
                    </div>

                    <!-- Menu -->
                    <nav class="space-y-1">
                        <button onclick="setTab('home')" class="w-full text-left p-2 rounded text-xs font-bold text-slate-300 hover:bg-slate-800 hover:text-white transition flex items-center gap-3 tab-btn active" id="btn-tab-home">
                            <div class="w-6 text-center"><i class="fas fa-newspaper"></i></div> ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£ & ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
                        </button>
                        <button onclick="setTab('parliament')" class="w-full text-left p-2 rounded text-xs font-bold text-slate-300 hover:bg-slate-800 hover:text-white transition flex items-center gap-3 tab-btn" id="btn-tab-parliament">
                            <div class="w-6 text-center"><i class="fas fa-landmark"></i></div> ‡∏£‡∏±‡∏ê‡∏™‡∏†‡∏≤ & ‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢
                        </button>
                        <button onclick="setTab('policies')" class="w-full text-left p-2 rounded text-xs font-bold text-slate-300 hover:bg-slate-800 hover:text-white transition flex items-center gap-3 tab-btn" id="btn-tab-policies">
                            <div class="w-6 text-center"><i class="fas fa-pen-fancy"></i></div> ‡πÄ‡∏™‡∏ô‡∏≠‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢
                        </button>
                    </nav>
                </div>
            </aside>

            <!-- CENTER CONTENT -->
            <section class="col-span-9 bg-slate-950 p-6 overflow-y-auto relative custom-scrollbar">
                
                <!-- TAB: HOME / NEWS -->
                <div id="tab-home" class="space-y-6 animate-fade-in">
                    
                    <!-- Breaking News Banner -->
                    <div id="breaking-banner" class="hidden bg-red-900/20 border-l-4 border-red-500 p-4 rounded shadow-lg flex items-start gap-4">
                        <div class="text-red-500 text-2xl animate-pulse"><i class="fas fa-exclamation-circle"></i></div>
                        <div>
                            <div class="text-red-400 font-bold text-sm uppercase tracking-wider mb-1">Breaking News</div>
                            <div id="breaking-title" class="text-white font-bold text-lg leading-tight mb-1">...</div>
                            <div id="breaking-desc" class="text-slate-300 text-xs">...</div>
                            <div id="breaking-actions" class="mt-3 flex gap-2"></div>
                        </div>
                    </div>

                    <!-- Live Stats & Chart -->
                    <div class="grid grid-cols-3 gap-6">
                        <div class="col-span-2 panel p-4 h-64 flex flex-col relative">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xs font-bold text-slate-400 flex items-center gap-2">
                                    <span class="live-dot"></span> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏¥‡∏¢‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå (Live Poll)
                                </h3>
                            </div>
                            <div class="flex-1 relative w-full h-full">
                                <canvas id="popChart"></canvas>
                            </div>
                        </div>
                        <div class="panel p-4 h-64 flex flex-col">
                            <h3 class="text-xs font-bold text-slate-400 mb-3 border-b border-slate-700 pb-2">‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏™‡∏±‡∏á‡∏Ñ‡∏° (Trends)</h3>
                            <div id="trends-list" class="space-y-2 text-xs flex-1 overflow-y-auto">
                                <div class="flex justify-between text-slate-300"><span>#‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÑ‡∏ó‡∏¢</span><span class="text-green-400">‚ñ≤</span></div>
                                <div class="flex justify-between text-slate-300"><span>#‡∏õ‡∏≤‡∏Å‡∏ó‡πâ‡∏≠‡∏á</span><span class="text-slate-500">-</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- News Feed -->
                    <div>
                        <h3 class="text-sm font-bold text-white mb-3">News Feed</h3>
                        <div id="news-feed" class="space-y-3">
                            <div class="bg-slate-900 p-3 rounded border border-slate-800 text-xs text-slate-400 text-center italic">
                                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà... ‡∏Å‡∏î Play ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: PARLIAMENT -->
                <div id="tab-parliament" class="hidden space-y-4">
                    <div id="vote-ui" class="hidden panel p-6 border-2 border-yellow-500/50 shadow-lg animate-pulse-slow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-yellow-400"><i class="fas fa-gavel"></i> ‡∏•‡∏á‡∏°‡∏ï‡∏¥‡∏ß‡∏≤‡∏£‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</h3>
                            <div id="vote-title" class="text-sm font-bold text-white">...</div>
                        </div>
                        <div class="relative w-full h-8 bg-slate-800 rounded-full overflow-hidden mb-4 border border-slate-600">
                            <div class="absolute inset-0 flex">
                                <div id="bar-yes" class="bg-green-600 h-full flex items-center justify-center text-[10px] font-bold text-white transition-all duration-700" style="width:0%">0</div>
                                <div id="bar-no" class="bg-red-600 h-full flex items-center justify-center text-[10px] font-bold text-white transition-all duration-700" style="width:0%">0</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <button onclick="castVote('yes')" class="py-2 bg-green-800 hover:bg-green-700 text-white rounded font-bold text-sm transition">‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏≠‡∏ö (Yes)</button>
                            <button onclick="castVote('abs')" class="py-2 bg-slate-700 hover:bg-slate-600 text-white rounded font-bold text-sm transition">‡∏á‡∏î‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Abs)</button>
                            <button onclick="castVote('no')" class="py-2 bg-red-800 hover:bg-red-700 text-white rounded font-bold text-sm transition">‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏≠‡∏ö (No)</button>
                        </div>
                    </div>

                    <h3 class="text-sm font-bold text-white mb-2 flex items-center gap-2"><i class="fas fa-file-contract text-blue-400"></i> ‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏≠‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ (Bill Queue)</h3>
                    <div id="bill-queue" class="grid grid-cols-2 gap-3">
                        <!-- JS Generated -->
                    </div>
                </div>

                <!-- TAB: POLICIES -->
                <div id="tab-policies" class="hidden h-full flex flex-col">
                    <div class="flex gap-2 overflow-x-auto pb-2 border-b border-slate-800 mb-4 shrink-0 custom-scrollbar" id="ministry-tabs">
                        <!-- Tabs -->
                    </div>
                    <div id="policy-list" class="grid grid-cols-3 gap-3 flex-1 overflow-y-auto custom-scrollbar">
                        <!-- Policies -->
                    </div>
                </div>

            </section>
        </main>
    </div>

    <!-- WAR ROOM MODAL (V14 STYLE RESTORED) -->
    <div id="war-room-modal" class="hidden absolute inset-0 z-50 bg-slate-950/95 backdrop-blur-md flex items-center justify-center p-8">
        <div class="bg-slate-900 border border-slate-700 rounded-lg w-full h-full max-w-6xl flex flex-col shadow-2xl overflow-hidden">
            <!-- Header -->
            <div class="h-14 bg-slate-800 border-b border-slate-700 flex justify-between items-center px-6">
                <h2 class="text-white font-bold text-lg flex items-center gap-2">
                    <i class="fas fa-map-marked-alt text-purple-500"></i> WAR ROOM: 400 CONSTITUENCIES
                </h2>
                <div class="flex gap-3">
                    <div class="flex items-center gap-2 bg-slate-800 px-3 rounded border border-slate-700 mr-2">
                        <span class="w-2 h-2 rounded-sm bg-red-500"></span><span class="text-[10px] text-slate-300">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢</span>
                        <span class="w-2 h-2 rounded-sm bg-orange-500"></span><span class="text-[10px] text-slate-300">‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤</span>
                        <span class="w-2 h-2 rounded-sm bg-blue-500"></span><span class="text-[10px] text-slate-300">‡∏£‡∏ß‡∏°‡πÑ‡∏ó‡∏¢</span>
                    </div>
                    <select id="map-mode" onchange="renderWarRoom()" class="bg-slate-800 text-white text-xs p-1 rounded border border-slate-600">
                        <option value="party">‚ö° ‡∏ú‡∏•‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á (Winner)</option>
                        <option value="economy">üí∞ ‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à (Economy)</option>
                    </select>
                    <button onclick="toggleWarRoom()" class="text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                </div>
            </div>

            <!-- Body -->
            <div class="flex-1 flex overflow-hidden">
                <!-- Map Grid Area -->
                <div class="flex-1 overflow-auto bg-slate-950 p-6 custom-scrollbar" id="map-scroll-area">
                    <div id="war-room-grid" class="flex gap-6 items-start">
                        <!-- Regions Columns will be injected here by renderWarRoom() -->
                    </div>
                </div>

                <!-- Right Sidebar (Inspector) -->
                <div class="w-80 bg-slate-900 border-l border-slate-800 p-4 flex flex-col shrink-0 shadow-xl z-10">
                    <div id="insp-empty" class="flex-1 flex flex-col items-center justify-center text-slate-600 opacity-50">
                        <i class="fas fa-search-location text-4xl mb-2"></i>
                        <span class="text-xs">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
                    </div>
                    
                    <div id="insp-content" class="hidden flex-col h-full">
                        <div class="mb-4">
                            <div class="text-[10px] text-slate-400 uppercase tracking-widest" id="insp-province">PROVINCE</div>
                            <div class="text-2xl font-bold text-white leading-none mb-1" id="insp-name">District 1</div>
                            <div class="text-xs font-bold text-blue-400 uppercase" id="insp-lean">NEUTRAL</div>
                        </div>

                        <!-- Projection Bars -->
                        <div class="bg-slate-800/50 p-3 rounded border border-slate-700 mb-4 flex-1 overflow-y-auto">
                            <div class="text-[10px] text-slate-400 mb-2 uppercase border-b border-slate-700 pb-1">‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Projection)</div>
                            <div id="insp-bars" class="space-y-3">
                                <!-- Bars injected here -->
                            </div>
                        </div>

                        <!-- Action Button -->
                        <button onclick="actionCampaignMap()" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold rounded shadow transition flex items-center justify-center gap-2">
                            <i class="fas fa-bullhorn"></i> ‡∏õ‡∏£‡∏≤‡∏®‡∏£‡∏±‡∏¢‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á ($50)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & CONSTANTS ---
        const PARTIES = [
            { id: 'mfp', name: '‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤', color: '#f97316', ideology: 'liberal', seats: 0 },
            { id: 'ptp', name: '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢', color: '#ef4444', ideology: 'populist', seats: 0 },
            { id: 'utn', name: '‡∏£‡∏ß‡∏°‡πÑ‡∏ó‡∏¢', color: '#3b82f6', ideology: 'conservative', seats: 0 },
            { id: 'pprp', name: '‡∏û‡∏•‡∏±‡∏á‡∏ò‡∏£‡∏£‡∏°', color: '#166534', ideology: 'authoritarian', seats: 0 },
            { id: 'bjt', name: '‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à', color: '#0ea5e9', ideology: 'neutral', seats: 0 }
        ];

        const REGIONS = {
            'bkk': { name: 'BANGKOK', color: 'region-border-bkk', provs: ['‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£'] },
            'central': { name: 'CENTRAL', color: 'region-border-central', provs: ['‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ','‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ','‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£','‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤','‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ','‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ'] },
            'east': { name: 'EAST', color: 'region-border-east', provs: ['‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ','‡∏£‡∏∞‡∏¢‡∏≠‡∏á','‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤','‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ'] },
            'northeast': { name: 'NORTHEAST', color: 'region-border-northeast', provs: ['‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤','‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô','‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ','‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ','‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå','‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå','‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©'] },
            'north': { name: 'NORTH', color: 'region-border-north', provs: ['‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà','‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢','‡∏•‡∏≥‡∏õ‡∏≤‡∏á','‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å','‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå'] },
            'south': { name: 'SOUTH', color: 'region-border-south', provs: ['‡∏™‡∏á‡∏Ç‡∏•‡∏≤','‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä','‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ','‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï','‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ','‡∏¢‡∏∞‡∏•‡∏≤','‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™'] }
        };

        const MINISTRIES = [
            {id:'mof', name:'‡∏Ñ‡∏•‡∏±‡∏á', icon:'üí∞'}, {id:'mod', name:'‡∏Å‡∏•‡∏≤‡πÇ‡∏´‡∏°', icon:'üõ°Ô∏è'}, 
            {id:'moac', name:'‡πÄ‡∏Å‡∏©‡∏ï‡∏£', icon:'üåæ'}, {id:'moph', name:'‡∏™‡∏ò.', icon:'üè•'},
            {id:'mot', name:'‡∏Ñ‡∏°‡∏ô‡∏≤‡∏Ñ‡∏°', icon:'üöÜ'}
        ];

        // --- STATE ---
        let state = {
            isPlaying: false,
            speed: 1,
            date: new Date(2024, 0, 1, 8, 0),
            timer: null,
            districts: [], // Holds 400+ district objects
            billQueue: [],
            activeBill: null,
            govParties: [],
            oppParties: []
        };
        let player = { name:'', role:'mp', partyId:'', districtId:null, pop:50, money:10 };
        let charts = {};
        let POLICIES_DB = [];
        let selectedDistrictId = null;

        // --- INIT ---
        window.onload = () => {
            initSetup();
            generatePolicies();
        };

        function initSetup() {
            const pSel = document.getElementById('inp-party');
            PARTIES.forEach(p => pSel.innerHTML += `<option value="${p.id}">${p.name}</option>`);
            pSel.innerHTML += `<option value="new">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏£‡∏£‡∏Ñ‡πÉ‡∏´‡∏°‡πà</option>`;
            updateProvinces();
        }

        // --- SETUP LOGIC ---
        function checkCustomParty(el) { document.getElementById('inp-custom-party').classList.toggle('hidden', el.value === 'new'); }
        
        function updateProvinces() {
            const r = document.getElementById('inp-region').value;
            const p = document.getElementById('inp-province');
            p.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î --</option>';
            p.disabled = !r;
            if(r && REGIONS[r]) REGIONS[r].provs.forEach(pv => p.innerHTML += `<option value="${pv}">${pv}</option>`);
            updateDistricts();
        }
        function updateDistricts() {
            const pv = document.getElementById('inp-province').value;
            const d = document.getElementById('inp-district');
            d.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï --</option>';
            d.disabled = !pv;
            if(pv) {
                let c = 3;
                if(pv==='‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£') c=33;
                else if(pv==='‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤') c=16;
                else if(pv==='‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà'||pv==='‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô') c=10;
                for(let i=1; i<=c; i++) d.innerHTML += `<option value="${pv}_${i}">${pv} ‡πÄ‡∏Ç‡∏ï ${i}</option>`;
            }
        }

        function startGame() {
            player.name = document.getElementById('inp-name').value;
            player.role = document.getElementById('inp-role').value;
            
            const pVal = document.getElementById('inp-party').value;
            if(pVal==='new') {
                const pid = 'cust_'+Date.now();
                PARTIES.push({ id: pid, name: document.getElementById('inp-custom-party').value||'New', color:'#fff', seats:0 });
                player.partyId = pid;
            } else player.partyId = pVal;
            
            player.districtId = document.getElementById('inp-district').value;
            if(!player.districtId) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï"); return; }

            // 1. Generate Complex World (V14 Logic)
            generateWorld();
            // 2. Initial Election Sim
            simulateElection();
            
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            
            updateUI();
            initCharts();
            renderPolicyTabs();
            renderWarRoom(); // Prepare map grid
            log("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡∏•‡∏≠‡∏á... ‡∏Å‡∏î Play ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤");
        }

        // --- CORE LOGIC (Restored from V14) ---
        function generateWorld() {
            state.districts = [];
            Object.entries(REGIONS).forEach(([rKey, rData]) => {
                rData.provs.forEach(prov => {
                    let c = 3;
                    if(prov==='‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£') c=33;
                    else if(prov==='‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤') c=16;
                    else if(prov==='‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà'||prov==='‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô'||prov==='‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ'||prov==='‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ'||prov==='‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä') c=10;
                    else if(prov==='‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ'||prov==='‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå') c=9;

                    for(let i=1; i<=c; i++) {
                        // Generate Candidates for this district
                        let candidates = PARTIES.map(p => ({
                            id: p.id,
                            votes: 0,
                            base: Math.random()*20 + (p.id===player.partyId ? player.pop/5 : 0) // Base support
                        }));

                        state.districts.push({
                            id: `${prov}_${i}`,
                            name: `‡πÄ‡∏Ç‡∏ï ${i}`,
                            prov: prov,
                            region: rKey,
                            candidates: candidates,
                            winner: null,
                            totalVotes: 30000 + Math.floor(Math.random()*10000),
                            eco: 40 + Math.floor(Math.random()*60)
                        });
                    }
                });
            });
        }

        function simulateElection() {
            // Recalculate votes for ALL districts based on current stats
            state.districts.forEach(d => {
                let max = -1;
                d.candidates.forEach(c => {
                    // Logic: Base + Random + Player Pop Influence (if player party)
                    let influence = (c.id === player.partyId) ? (player.pop - 50) / 2 : 0;
                    let raw = c.base + influence + (Math.random()*5); 
                    c.votes = Math.floor(Math.max(0, raw) * (d.totalVotes/100));
                    
                    if(c.votes > max) { max = c.votes; d.winner = c.id; }
                });
            });
            // Tally Seats
            PARTIES.forEach(p => p.seats = state.districts.filter(d=>d.winner===p.id).length);
            
            // Gov Formation logic (simple)
            state.govParties = [player.partyId];
            let s = PARTIES.find(p=>p.id===player.partyId).seats;
            PARTIES.filter(p=>p.id!==player.partyId).sort((a,b)=>b.seats-a.seats).forEach(p => {
                if(s < 251) { state.govParties.push(p.id); s+=p.seats; }
            });
        }

        function generatePolicies() {
            POLICIES_DB = [];
            const levels = [{s:'I',m:1},{s:'II',m:3},{s:'III',m:5}];
            MINISTRIES.forEach(m => {
                ['‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏ö','‡∏•‡∏î‡∏á‡∏ö','‡∏õ‡∏è‡∏¥‡∏£‡∏π‡∏õ','‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠'].forEach(act => {
                    levels.forEach(lv => {
                        POLICIES_DB.push({
                            id: `${m.id}_${act}_${lv.s}`, mid: m.id, 
                            name: `${act} ${m.name} ‡∏£‡∏∞‡∏î‡∏±‡∏ö ${lv.s}`, 
                            cost: 50 * lv.m
                        });
                    });
                });
            });
        }

        // --- TIME SYSTEM (REAL-TIME) ---
        function togglePlay() {
            state.isPlaying = !state.isPlaying;
            const btn = document.getElementById('btn-play');
            if(state.isPlaying) {
                btn.innerHTML = '<i class="fas fa-pause"></i>';
                btn.className = "w-8 h-8 flex items-center justify-center bg-yellow-600 hover:bg-yellow-500 rounded text-white";
                runGameLoop();
            } else {
                btn.innerHTML = '<i class="fas fa-play"></i>';
                btn.className = "w-8 h-8 flex items-center justify-center bg-green-600 hover:bg-green-500 rounded text-white";
                clearInterval(state.timer);
            }
        }

        function setSpeed(s) { state.speed = s; if(state.isPlaying) { clearInterval(state.timer); runGameLoop(); } }

        function runGameLoop() {
            const tickRate = 200 / state.speed;
            state.timer = setInterval(() => {
                state.date.setHours(state.date.getHours() + 6);
                
                // Real-time updates
                checkCrises();
                updatePopulation();
                
                // Trigger Election Sim periodically (e.g. every week in game) to reflect poll changes
                if(state.date.getHours() === 6 && state.date.getDay() === 1) {
                    simulateElection();
                    if(!document.getElementById('war-room-modal').classList.contains('hidden')) renderWarRoom(); // Refresh map if open
                    updateSidebarMyDistrict(); // Refresh my district stats
                }

                updateTimeDisplay();
                updateChartsRealtime();
                
                // Bill Queue Countdown
                if(state.billQueue.length > 0 && state.date.getHours() === 12) {
                    state.billQueue.forEach(b => b.remaining -= 0.1); // Slow decay
                }

            }, tickRate);
        }

        function checkCrises() {
            const month = state.date.getMonth();
            const roll = Math.random();
            let event = null;
            if(month >= 2 && month <= 4 && roll > 0.998) event = { t:'‡∏†‡∏±‡∏¢‡πÅ‡∏•‡πâ‡∏á‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á', d:'‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏Ç‡∏≤‡∏î‡πÅ‡∏Ñ‡∏•‡∏ô‡∏ô‡πâ‡∏≥', type:'crisis' };
            else if(month >= 7 && month <= 9 && roll > 0.998) event = { t:'‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‡πÉ‡∏´‡∏ç‡πà', d:'‡∏°‡∏ß‡∏•‡∏ô‡πâ‡∏≥‡∏´‡∏•‡∏≤‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡πà‡∏ß‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà', type:'crisis' };
            
            if(event && !document.getElementById('breaking-banner').classList.contains('flex')) {
                triggerEvent(event);
            }
        }

        function updatePopulation() {
            const volatility = 0.2;
            player.pop = Math.min(100, Math.max(0, player.pop + (Math.random()*volatility - volatility/2)));
            document.getElementById('val-pop').textContent = player.pop.toFixed(1) + '%';
        }

        // --- EVENT SYSTEM ---
        function triggerEvent(ev) {
            state.isPlaying = false; togglePlay();
            const banner = document.getElementById('breaking-banner');
            document.getElementById('breaking-title').textContent = ev.t;
            document.getElementById('breaking-desc').textContent = ev.d;
            document.getElementById('breaking-actions').innerHTML = `
                <button onclick="resolveEvent(true)" class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏î‡πà‡∏ß‡∏ô ($50M)</button>
                <button onclick="resolveEvent(false)" class="px-3 py-1 bg-slate-700 text-white text-xs rounded">‡πÄ‡∏û‡∏¥‡∏Å‡πÄ‡∏â‡∏¢</button>
            `;
            banner.classList.remove('hidden'); banner.classList.add('flex');
            log(`BREAKING: ${ev.t}`, true);
        }

        function resolveEvent(doAction) {
            document.getElementById('breaking-banner').classList.add('hidden');
            document.getElementById('breaking-banner').classList.remove('flex');
            if(doAction) { player.money -= 50; player.pop += 5; log("‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡πà‡∏ß‡∏á‡∏ó‡∏µ (+Pop)"); } 
            else { player.pop -= 10; log("‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÇ‡∏Å‡∏£‡∏ò‡πÅ‡∏Ñ‡πâ‡∏ô (-Pop)"); }
            updateUI(); togglePlay();
        }

        // --- WAR ROOM (LOGIC RESTORED) ---
        function toggleWarRoom() {
            const m = document.getElementById('war-room-modal');
            m.classList.toggle('hidden');
            if(!m.classList.contains('hidden')) renderWarRoom();
        }

        function renderWarRoom() {
            const grid = document.getElementById('war-room-grid');
            grid.innerHTML = '';
            const mode = document.getElementById('map-mode').value;

            // Group districts by Region -> Province
            Object.entries(REGIONS).forEach(([rKey, rData]) => {
                const col = document.createElement('div');
                col.className = 'wr-region-col';
                col.innerHTML = `<div class="wr-region-header ${rData.color}">${rData.name}</div>`;

                const provGroups = {};
                state.districts.filter(d => d.region === rKey).forEach(d => {
                    if(!provGroups[d.prov]) provGroups[d.prov] = [];
                    provGroups[d.prov].push(d);
                });

                Object.entries(provGroups).forEach(([pName, dists]) => {
                    const card = document.createElement('div');
                    card.className = 'wr-province-card';
                    if(player.districtId && player.districtId.startsWith(pName)) card.classList.add('my-prov');
                    card.innerHTML = `<div class="wr-province-name">${pName}</div>`;
                    
                    const dGrid = document.createElement('div');
                    dGrid.className = 'wr-district-grid';

                    dists.forEach(d => {
                        const box = document.createElement('div');
                        box.className = `wr-district-box ${selectedDistrictId===d.id ? 'selected' : ''}`;
                        box.title = `${d.prov} ${d.name}`;
                        
                        if(mode === 'economy') {
                            const v = d.eco/100;
                            box.style.backgroundColor = `rgba(34, 197, 94, ${v})`;
                        } else {
                            const winP = PARTIES.find(p=>p.id===d.winner);
                            box.style.backgroundColor = winP ? winP.color : '#333';
                        }

                        box.onclick = () => selectDistrict(d);
                        dGrid.appendChild(box);
                    });

                    card.appendChild(dGrid);
                    col.appendChild(card);
                });
                grid.appendChild(col);
            });
        }

        function selectDistrict(d) {
            selectedDistrictId = d.id;
            renderWarRoom(); // Highlight selection

            document.getElementById('insp-empty').classList.add('hidden');
            document.getElementById('insp-content').classList.remove('hidden');
            document.getElementById('insp-content').classList.add('flex');

            document.getElementById('insp-province').textContent = d.prov;
            document.getElementById('insp-name').textContent = d.name;
            
            const winP = PARTIES.find(p=>p.id===d.winner);
            const leanEl = document.getElementById('insp-lean');
            leanEl.textContent = winP ? `‡∏ô‡∏≥‡πÇ‡∏î‡∏¢: ${winP.name}` : 'NEUTRAL';
            leanEl.style.color = winP ? winP.color : '#ccc';

            // Render Projection Bars
            const barsContainer = document.getElementById('insp-bars');
            barsContainer.innerHTML = '';
            
            d.candidates.sort((a,b)=>b.votes-a.votes).forEach(c => {
                const p = PARTIES.find(x=>x.id===c.id);
                const pct = (c.votes / d.totalVotes) * 100;
                
                barsContainer.innerHTML += `
                    <div>
                        <div class="flex justify-between text-[10px] text-slate-300 mb-1">
                            <span>${p.name}</span>
                            <span class="font-mono">${c.votes.toLocaleString()}</span>
                        </div>
                        <div class="wr-bar-bg">
                            <div class="wr-bar-fill" style="width:${pct}%; background-color:${p.color}"></div>
                        </div>
                    </div>
                `;
            });
        }

        function actionCampaignMap() {
            if(!selectedDistrictId) return;
            if(player.money < 50) { alert('‡∏á‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏≠'); return; }
            player.money -= 50;
            
            const d = state.districts.find(x=>x.id===selectedDistrictId);
            const myCand = d.candidates.find(c=>c.id===player.partyId);
            if(myCand) {
                myCand.base += 10; // Permanent boost base
                simulateElection(); // Re-calculate immediately
                selectDistrict(d); // Update inspector
                renderWarRoom(); // Update map colors
                updateUI();
                log(`‡∏õ‡∏£‡∏≤‡∏®‡∏£‡∏±‡∏¢‡πÉ‡∏ô ${d.name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
            }
        }

        // --- UI & UPDATES ---
        function updateTimeDisplay() {
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            document.getElementById('clock-date').textContent = state.date.toLocaleDateString('en-GB', options);
            document.getElementById('clock-time').textContent = state.date.toLocaleTimeString('en-GB', { hour: '2-digit', minute:'2-digit' }) + " ‡∏ô.";
        }

        function updateUI() {
            const elName = document.getElementById('ui-name'); if(elName) elName.textContent = player.name;
            const p = PARTIES.find(x=>x.id===player.partyId);
            const elParty = document.getElementById('ui-party'); if(elParty && p) { elParty.textContent = p.name; elParty.style.color = p.color; }
            const elMoney = document.getElementById('val-money'); if(elMoney) elMoney.textContent = '$'+player.money.toFixed(1)+'M';
            
            // Sidebar
            const sbName = document.getElementById('sb-name'); if(sbName) sbName.textContent = player.name;
            const sbParty = document.getElementById('sb-party'); if(sbParty && p) sbParty.textContent = p.name;
            
            updateSidebarMyDistrict();
        }

        function updateSidebarMyDistrict() {
            if(!player.districtId) return;
            const md = state.districts.find(d=>d.id===player.districtId);
            if(md) {
                document.getElementById('sb-dist-name').textContent = `${md.prov} ${md.name}`;
                
                // Find my vote count and rank
                const myCand = md.candidates.find(c=>c.id===player.partyId);
                const sorted = [...md.candidates].sort((a,b)=>b.votes-a.votes);
                const rank = sorted.findIndex(c=>c.id===player.partyId) + 1;
                
                document.getElementById('sb-my-votes').textContent = myCand.votes.toLocaleString();
                document.getElementById('sb-rank').textContent = `‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö: ${rank}`;
                
                // Bar
                const maxVotes = sorted[0].votes || 1;
                const pct = (myCand.votes / maxVotes) * 100;
                document.getElementById('sb-vote-bar').style.width = pct + '%';
            }
        }

        function log(msg, isCrisis=false) {
            const f = document.getElementById('news-feed');
            const time = state.date.toLocaleTimeString('en-GB', { hour: '2-digit', minute:'2-digit' });
            const item = document.createElement('div');
            item.className = `news-item bg-slate-900/50 p-2 rounded mb-2 text-xs text-slate-300 ${isCrisis ? 'crisis' : ''}`;
            item.innerHTML = `<span class="text-slate-500 font-mono mr-2">[${time}]</span> ${msg}`;
            f.prepend(item);
        }

        // --- CHARTS & ACTIONS ---
        function initCharts() {
            const ctx = document.getElementById('popChart').getContext('2d');
            charts.pop = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(20).fill(''),
                    datasets: [{ label: 'Popularity', data: Array(20).fill(50), borderColor: '#4ade80', borderWidth: 2, tension: 0.4, pointRadius: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { min: 0, max: 100, grid: { color: '#334155' } }, x: { display: false } }, animation: false }
            });
        }
        function updateChartsRealtime() {
            const data = charts.pop.data.datasets[0].data;
            data.shift(); data.push(player.pop); charts.pop.update();
        }

        function actionVisit() { player.money-=2; player.pop+=0.5; log("‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà +Pop"); }
        function actionLobby() { player.money-=5; log("‡∏•‡πá‡∏≠‡∏ö‡∏ö‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); }
        function actionMedia() { player.money-=3; player.pop+=1; log("‡∏≠‡∏≠‡∏Å‡∏™‡∏∑‡πà‡∏≠ +Pop"); }
        function actionFund() { player.money+=10; player.pop-=1; log("‡∏£‡∏∞‡∏î‡∏°‡∏ó‡∏∏‡∏ô +Money"); }

        function renderPolicyTabs() {
            const c = document.getElementById('ministry-tabs'); c.innerHTML='';
            MINISTRIES.forEach(m => c.innerHTML += `<button onclick="renderPolicies('${m.id}')" class="px-3 py-1 bg-slate-800 border border-slate-700 hover:bg-slate-700 text-white rounded text-xs shrink-0">${m.icon} ${m.name}</button>`);
            renderPolicies('mof');
        }
        function renderPolicies(mid) {
            const l = document.getElementById('policy-list'); l.innerHTML = '';
            POLICIES_DB.filter(p => p.mid === mid).forEach(p => {
                l.innerHTML += `<div class="bg-slate-800 p-2 rounded border border-slate-700 hover:bg-slate-700 cursor-pointer" onclick="proposePolicy('${p.id}')"><div class="font-bold text-xs text-white">${p.name}</div><div class="text-[9px] text-yellow-500">$${p.cost}M</div></div>`;
            });
        }
        function proposePolicy(pid) {
            const p = POLICIES_DB.find(x=>x.id===pid);
            player.money -= 5;
            state.billQueue.push({ ...p, remaining: 30 }); // 30 ticks
            updateBillQueueUI();
            log(`‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡πà‡∏≤‡∏á: ${p.name}`);
            setTab('parliament');
        }
        function updateBillQueueUI() {
            const c = document.getElementById('bill-queue'); c.innerHTML = '';
            state.billQueue.forEach(b => {
                c.innerHTML += `<div class="bg-slate-800 p-3 rounded border border-slate-700 flex justify-between items-center"><div class="text-xs text-white font-bold">${b.name}</div><button onclick="voteBill('${b.id}')" class="px-2 py-1 bg-blue-600 text-[10px] text-white rounded">‡πÇ‡∏´‡∏ß‡∏ï</button></div>`;
            });
        }
        function voteBill(bid) {
            const idx = state.billQueue.findIndex(x=>x.id===bid);
            state.activeBill = state.billQueue[idx];
            state.billQueue.splice(idx, 1);
            updateBillQueueUI();
            document.getElementById('vote-ui').classList.remove('hidden');
            document.getElementById('vote-title').textContent = state.activeBill.name;
        }
        function castVote(c) {
            document.getElementById('vote-ui').classList.add('hidden');
            if(c==='yes'){player.pop+=2; log("‡∏°‡∏ï‡∏¥‡∏ú‡πà‡∏≤‡∏ô!");} else {player.pop-=1; log("‡∏°‡∏ï‡∏¥‡∏ï‡∏Å!");}
        }
        function setTab(t) { ['home','parliament','policies'].forEach(x=>{document.getElementById(`tab-${x}`).classList.add('hidden');document.getElementById(`btn-tab-${x}`).classList.remove('active');}); document.getElementById(`tab-${t}`).classList.remove('hidden'); document.getElementById(`btn-tab-${t}`).classList.add('active'); }
    </script>
</body>
</html>
